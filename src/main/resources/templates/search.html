<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head(title=${title}, description=${description}, canonicalUrl=${canonicalUrl}, ogImage=${ogImage}, keywords=${keywords})}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - Book Finder</title>
</head>
<body>

<!-- Navbar -->
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <!-- Search Header -->
        <div class="search-header bg-white p-4 rounded-3 shadow-sm mb-4">
                        <form action="/search" method="get" class="mb-4">
                <div class="row g-2 justify-content-center">
                    <div th:class="${isYearFilteringEnabled} ? 'col-md-10' : 'col-md-12 col-lg-10 mx-auto'">
                        <div class="input-group">
                            <input type="text" id="searchInput" name="query" class="form-control" 
                                   th:value="${query}" placeholder="Search by title, author, or keyword..." required>
                            <button class="btn btn-primary" type="submit" aria-label="Search">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2" th:if="${isYearFilteringEnabled}">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <input type="number" id="yearInput" name="year" class="form-control no-spinner" 
                                   th:value="${year}" placeholder="Year" min="1800" max="2099">
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Search Filters -->
            <div class="d-flex flex-wrap align-items-center gap-2" id="searchFilters">
                <div class="me-auto">
                    <span th:if="${query}" class="text-muted">
                        Results for: <span class="fw-bold" th:text="${query}"></span>
                    </span>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                            id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort me-1"></i> Sort By
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                        <li><a class="dropdown-item sort-option" href="#" data-sort="relevance">Relevance</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="title">Title</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="author">Author</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="newest">Newest First</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="rating">Highest Rated</a></li>
                    </ul>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                            id="viewDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-th-large me-1"></i> View
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="viewDropdown">
                        <li><a class="dropdown-item view-option active" href="#" data-view="grid">Grid View</a></li>
                        <li><a class="dropdown-item view-option" href="#" data-view="list">List View</a></li>
                    </ul>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                            id="coverSourceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-image me-1"></i> Cover Source
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="coverSourceDropdown">
                        <li><a class="dropdown-item cover-source-option active" href="#" data-source="ANY">Any Source</a></li>
                        <li><a class="dropdown-item cover-source-option" href="#" data-source="GOOGLE_BOOKS">Google Books</a></li>
                        <li><a class="dropdown-item cover-source-option" href="#" data-source="OPEN_LIBRARY">Open Library</a></li>
                        <li><a class="dropdown-item cover-source-option" href="#" data-source="LONGITOOD">Longitood</a></li>
                    </ul>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                            id="resolutionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-expand me-1"></i> Resolution
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="resolutionDropdown">
                        <li><a class="dropdown-item resolution-option active" href="#" data-resolution="ANY">Any Resolution</a></li>
                        <li><a class="dropdown-item resolution-option" href="#" data-resolution="HIGH_ONLY">High Resolution Only</a></li>
                        <li><a class="dropdown-item resolution-option" href="#" data-resolution="HIGH_FIRST">High Resolution First</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center py-5 d-none" style="background-color: transparent; min-height: 300px;">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 fs-5">Searching for books...</p>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults" class="mb-4" style="background-color: transparent;">
            <!-- Results will be loaded here via JavaScript -->
            <div class="text-center py-5" id="initialSearchPrompt">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>Enter a search term to find books</h4>
                <p class="text-muted">Search by title, author, ISBN, or keywords</p>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Search results pages" class="d-flex justify-content-center mt-4 mb-4 d-none" id="paginationNav">
            <ul class="pagination" id="pagination">
                <!-- Pagination will be added via JavaScript -->
            </ul>
        </nav>
    </div>
</main>

<!-- Footer -->
<footer th:replace="~{fragments/layout :: footer}"></footer>

<!-- Result Item Template for JavaScript -->
<template id="bookCardTemplate">
    <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
        <div class="card h-100">
            <div class="position-relative book-cover-container">
                <img src="/images/placeholder-book-cover.svg" 
                     class="card-img-top book-cover" 
                     loading="lazy"
                     data-book-id="" 
                     data-preferred-url="" 
                     data-fallback-url="/images/placeholder-book-cover.svg" 
                     data-ultimate-fallback="/images/placeholder-book-cover.svg" 
                     alt="Book cover">
                <div class="position-absolute top-0 end-0 m-2 badge bg-warning text-dark rating-badge">
                    <i class="fas fa-star me-1"></i>
                    <span class="rating-value">4.5</span>
                </div>
                <div class="position-absolute bottom-0 start-0 m-2 d-flex flex-column qualifier-badges">
                    <!-- Will be populated with badges if qualifiers exist -->
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title text-truncate book-title">Book Title</h5>
                <p class="card-text small text-muted text-truncate book-author">Author Name</p>
            </div>
            <div class="card-footer bg-white border-top-0">
                <a href="#" class="btn btn-sm btn-outline-primary d-block book-link">View Details</a>
            </div>
        </div>
    </div>
</template>

<template id="bookListItemTemplate">
    <div class="col-12 mb-3">
        <div class="card">
            <div class="row g-0">
                <div class="col-md-2">
                    <div class="position-relative book-cover-container book-cover-wrapper h-100">
                        <img src="/images/placeholder-book-cover.svg" 
                             class="img-fluid rounded-start book-cover" 
                             loading="lazy"
                             data-book-id="" 
                             data-preferred-url="" 
                             data-fallback-url="/images/placeholder-book-cover.svg" 
                             data-ultimate-fallback="/images/placeholder-book-cover.svg" 
                             alt="Book cover">
                        <div class="position-absolute top-0 end-0 m-2 badge bg-warning text-dark rating-badge">
                            <i class="fas fa-star me-1"></i>
                            <span class="rating-value">4.5</span>
                        </div>
                        <div class="position-absolute bottom-0 start-0 m-2 d-flex flex-column qualifier-badges">
                            <!-- Will be populated with badges if qualifiers exist -->
                        </div>
                    </div>
                </div>
                <div class="col-md-10">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title book-title">Book Title</h5>
                                <p class="card-text text-muted book-author">Author Name</p>
                            </div>
                            <a href="#" class="btn btn-sm btn-outline-primary book-link">View Details</a>
                        </div>
                        <p class="card-text book-description">Book description will be displayed here...</p>
                        <div class="d-flex flex-wrap gap-1 mt-2 book-categories">
                            <!-- Categories will be added here -->
                        </div>
                        <div class="d-flex flex-wrap gap-1 mt-2 list-view-qualifier-badges">
                            <!-- Will be populated with badges if qualifiers exist -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Scripts -->
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>

<!-- Cover Source Handler Script -->
<script src="/js/cover-source-handler.js"></script>

<!-- Search Page Scripts -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const query = /*[[${query}]]*/ null;
        const isDevelopmentMode = /*[[${isDevelopmentMode}]]*/ false; // Make dev mode status available to JS
        const initialYear = /*[[${year}]]*/ null; // Year parameter from server
        const resultsContainer = document.getElementById('searchResults');
        const paginationContainer = document.getElementById('pagination'); // This is the UL
        const paginationNav = document.getElementById('paginationNav'); // This is the NAV container
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Current search state
        let currentPage = 0;
        let currentSort = 'newest'; // Default sort to newest
        let currentView = 'grid';
        let currentMaxResults = 12;
        let currentCoverSource = 'ANY';
        let currentResolution = 'HIGH_FIRST'; // Default to HIGH_FIRST
        let publishedYear = initialYear; // Published year filter from server or URL params
        
        // Initialize search if query exists
        if (query) {
            // Get page from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const urlPage = urlParams.get('page');
            
            // Get published year from URL if present
            const urlYear = urlParams.get('year');
            if (urlYear) {
                const yearNum = parseInt(urlYear);
                if (!isNaN(yearNum)) {
                    publishedYear = yearNum;
                }
            }
            if (urlPage) {
                // URL parameter is 1-indexed, but our internal currentPage is 0-indexed
                currentPage = parseInt(urlPage) - 1;
                
                // Handle invalid or negative values
                if (isNaN(currentPage) || currentPage < 0) {
                    currentPage = 0;
                }
            }
            
            // Get sort from URL if present, otherwise use currentSort (defaulted to 'newest')
            const urlSort = urlParams.get('sort');
            if (urlSort) {
                currentSort = urlSort;
            }
            // Update sort dropdown text and active state based on currentSort
            let sortDropdownText = currentSort.charAt(0).toUpperCase() + currentSort.slice(1);
            if (currentSort === 'newest') sortDropdownText = 'Newest First'; // Display text for 'newest'
            document.getElementById('sortDropdown').innerHTML =
                `<i class="fas fa-sort me-1"></i> Sort: ${sortDropdownText}`;
            document.querySelectorAll('.sort-option').forEach(opt => {
                if (opt.getAttribute('data-sort') === currentSort) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });
            
            // Get view from URL if present
            const urlView = urlParams.get('view');
            if (urlView) {
                currentView = urlView;
                document.querySelectorAll('.view-option').forEach(opt => {
                    if (opt.getAttribute('data-view') === currentView) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }

            // Get cover source from URL if present
            const urlCoverSource = urlParams.get('coverSource');
            if (urlCoverSource) {
                currentCoverSource = urlCoverSource;
                let coverSourceText = urlCoverSource.replace('_', ' ').toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                if (urlCoverSource === 'ANY') coverSourceText = 'Any Source'; // Special case for "ANY"
                document.getElementById('coverSourceDropdown').innerHTML =
                    `<i class="fas fa-image me-1"></i> Source: ${coverSourceText}`;
                
                // Update active state in dropdown
                document.querySelectorAll('.cover-source-option').forEach(opt => {
                    if (opt.getAttribute('data-source') === urlCoverSource) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }
            
            // Get resolution preference from URL if present, otherwise use default
            const urlResolution = urlParams.get('resolution');
            if (urlResolution) {
                currentResolution = urlResolution;
            }
            // Update dropdown text and active state based on currentResolution (either from URL or default)
            let displayText = 'Any Resolution'; // Default capitalized
            if (currentResolution === 'HIGH_ONLY') {
                displayText = 'High Resolution Only';
            } else if (currentResolution === 'HIGH_FIRST') {
                displayText = 'High Resolution First';
            }
            document.getElementById('resolutionDropdown').innerHTML =
                `<i class="fas fa-expand me-1"></i> ${displayText}`;
            
            // Update active state in dropdown for resolution
            document.querySelectorAll('.resolution-option').forEach(opt => {
                if (opt.getAttribute('data-resolution') === currentResolution) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });

            // Check if the page was loaded from the Explore feature
            const urlSource = urlParams.get('source');
            if (urlSource === 'explore' && query) {
                const resultsForTextElements = document.querySelectorAll('.search-header .text-muted');
                resultsForTextElements.forEach(el => {
                    const boldQuerySpan = el.querySelector('span.fw-bold');
                    // Check if the bold span exists and its text content matches the current query
                    if (boldQuerySpan && boldQuerySpan.textContent === query) {
                        el.innerHTML = `Exploring: <span class="fw-bold">${query}</span> <i class="fas fa-compass ms-1 text-primary"></i>`;
                        document.title = `Exploring: ${query} - Book Finder`;
                    }
                });
            }
            
            performSearch(query, currentPage * currentMaxResults, currentSort, currentCoverSource, currentResolution, publishedYear);
        }
        
        // View toggle handlers
        document.querySelectorAll('.view-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const view = this.getAttribute('data-view');
                
                // Update active state
                document.querySelectorAll('.view-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                currentView = view;

                // Update URL without reloading
                const url = new URL(window.location.href);
                url.searchParams.set('view', view);
                window.history.pushState({}, '', url);
                
                // If it has search results, re-render them
                if (query) {
                    displayResults(window.lastSearchResults, currentView);
                }
            });
        });
        
        // Sort option handlers
        document.querySelectorAll('.sort-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const sortBy = this.getAttribute('data-sort');
                
                // Update dropdown button text
                let sortButtonText = sortBy.charAt(0).toUpperCase() + sortBy.slice(1);
                if (sortBy === 'newest') sortButtonText = 'Newest First';
                document.getElementById('sortDropdown').innerHTML =
                    `<i class="fas fa-sort me-1"></i> Sort: ${sortButtonText}`;
                
                currentSort = sortBy;

                // Update URL without reloading
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sortBy);
                window.history.pushState({}, '', url);

                // Mark as active
                document.querySelectorAll('.sort-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                
                // If it has search results, re-sort and re-render them
                if (query) {
                    performSearch(query, 0, sortBy, currentCoverSource, currentResolution, publishedYear);
                }
            });
        });
        
        // Cover source option handlers
        document.querySelectorAll('.cover-source-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const source = this.getAttribute('data-source');
                currentCoverSource = source;
                
                // Update dropdown button text
                let coverSourceButtonText = source.replace('_', ' ').toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                if (source === 'ANY') coverSourceButtonText = 'Any Source';
                document.getElementById('coverSourceDropdown').innerHTML =
                    `<i class="fas fa-image me-1"></i> Source: ${coverSourceButtonText}`;
                
                // Update URL without reloading
                const url = new URL(window.location.href);
                url.searchParams.set('coverSource', source);
                window.history.pushState({}, '', url);
                
                // Mark as active
                document.querySelectorAll('.cover-source-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                
                // Reload search results
                currentPage = 0;
                performSearch(query, 0, currentSort, currentCoverSource, currentResolution, publishedYear);
            });
        });
        
        // Handle resolution preference selection
        document.querySelectorAll('.resolution-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const resolution = this.getAttribute('data-resolution');
                currentResolution = resolution;
                
                // Update dropdown button text
                let displayText = 'Any Resolution'; // Default capitalized
                if (resolution === 'HIGH_ONLY') {
                    displayText = 'High Resolution Only';
                } else if (resolution === 'HIGH_FIRST') {
                    displayText = 'High Resolution First';
                }
                
                document.getElementById('resolutionDropdown').innerHTML =
                    `<i class="fas fa-expand me-1"></i> ${displayText}`;
                
                // Update URL without reloading
                const url = new URL(window.location.href);
                url.searchParams.set('resolution', resolution);
                window.history.pushState({}, '', url);
                
                // Mark as active
                document.querySelectorAll('.resolution-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                
                // Reload search results
                currentPage = 0;
                performSearch(query, 0, currentSort, currentCoverSource, currentResolution, publishedYear);
            });
        });
        
        // Add event listener for the year input field
        const yearInput = document.getElementById('yearInput');
        if (yearInput) {
            // Handle blur (focus lost) to apply year filter
            yearInput.addEventListener('blur', function() {
                const yearValue = this.value ? parseInt(this.value) : null;
                if (yearValue !== publishedYear) {
                    console.log("Year input changed to:", yearValue);
                    publishedYear = yearValue;
                    
                    // Update URL
                    const url = new URL(window.location.href);
                    if (yearValue) {
                        url.searchParams.set('year', yearValue);
                    } else {
                        url.searchParams.delete('year');
                    }
                    window.history.pushState({}, '', url);
                    
                    // Reload search results
                    currentPage = 0;
                    performSearch(query, 0, currentSort, currentCoverSource, currentResolution, publishedYear);
                }
            });
            
            // Handle Enter key press
            yearInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    this.blur(); // Trigger the blur event
                }
            });
        }
        
        function performSearch(query, startIndex, sortBy, coverSource, resolution, year) {
            if (!query) return;
            
            // Show loading indicator and completely hide results container
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none'; // Hide completely during loading
            loadingIndicator.classList.remove('d-none');
            
            // Reset pagination container at the start of each search
            if (paginationNav) paginationNav.classList.add('d-none'); // Hide nav by default
            paginationContainer.innerHTML = '';
            // paginationContainer.style.display = 'flex'; // Controlled by paginationNav's d-none
            // paginationContainer.style.border = 'none'; // Styling can be done in CSS
            
            // Build the URL
            let apiUrl = `/api/books/search?query=${encodeURIComponent(query)}&startIndex=${startIndex}&maxResults=${currentMaxResults}`;
            
            // Add sort parameter if not default
            if (sortBy && sortBy !== 'relevance') {
                apiUrl += `&orderBy=${sortBy}`;
            }
            
            // Add resolution parameter if not default
            if (resolution && resolution !== 'ANY') {
                apiUrl += `&resolution=${resolution}`;
            }
            
            // Add cover source parameter if not default
            if (coverSource && coverSource !== 'ANY') {
                apiUrl += `&coverSource=${coverSource}`;
            }
            
            // Add published year parameter if provided
            if (year) {
                apiUrl += `&publishedYear=${year}`;
                
                // Also update the URL to include the year parameter for sharing/bookmarking
                const url = new URL(window.location.href);
                url.searchParams.set('year', year);
                window.history.pushState({}, '', url);
                
                // Set the year input field value
                const yearInput = document.getElementById('yearInput');
                if (yearInput && yearInput.value !== year) {
                    yearInput.value = year;
                    console.log("Set year input field to", year);
                }
            }
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search request failed');
                    }
                    return response.json();
                })
                .then(data => {
                    loadingIndicator.classList.add('d-none');
                    resultsContainer.style.display = 'block'; // Show results container again
                    window.lastSearchResults = data;
                    
                    // Display detected year if applicable
                    if (year) {
                        const resultsText = document.querySelector('.search-header .text-muted');
                        if (resultsText) {
                            // Show that we're filtering by year
                            resultsText.innerHTML = `Results for: <span class="fw-bold">${query}</span> <span class="badge bg-info ms-2">Published in ${year} <i class="fas fa-calendar-alt ms-1"></i></span>`;
                            
                            // Also set the year input field
                            const yearInput = document.getElementById('yearInput');
                            if (yearInput) {
                                yearInput.value = year;
                            }
                        }
                    }
                    
                    console.log("Search results data:", data);
                    console.log("Total available results:", data.totalAvailableResults);
                    console.log("Current max results:", currentMaxResults);
                    
                    if (sortBy && sortBy !== 'relevance') {
                        sortResults(data.results, sortBy);
                    }
                    
                    displayResults(data, currentView);
                    
                    /**
                     * Setup pagination based on available response data
                     * @since the API doesn't provide totalAvailableResults
                     */
                    console.log("Available data for pagination:", data);
                    
                    // Detect if more pages likely exist
                    const hasMoreResults = data.count >= currentMaxResults || data.resultsInPage >= currentMaxResults;
                    console.log("Has more results:", hasMoreResults, "Current page:", currentPage);
                    
                    /**
                     * Show pagination if:
                     * 1. Not on first page, OR
                     * 2. Full page of results (suggesting more exist)
                     */
                    if (data.count > 0 && (currentPage > 0 || hasMoreResults)) {
                        // Calculate minimum estimated total for pagination buttons
                        const estimatedTotal = Math.max(
                            (currentPage + 1) * currentMaxResults + (hasMoreResults ? currentMaxResults : 0),
                            data.count
                        );
                        console.log("Setting up pagination with estimated total:", estimatedTotal);
                        setupPagination(currentPage, estimatedTotal, currentMaxResults);
                        if (paginationContainer.innerHTML.trim() !== '' && paginationNav) {
                            paginationNav.classList.remove('d-none'); // Show nav if pagination was populated
                        }
                        console.log("Pagination container HTML after setup:", paginationContainer.innerHTML);
                    } else {
                        console.log("Not setting up pagination. No data suggesting more pages.");
                        paginationContainer.innerHTML = '';
                        if (paginationNav) paginationNav.classList.add('d-none'); // Ensure nav is hidden
                    }
                })
                .catch(error => {
                    console.error('Error fetching search results:', error);
                    resultsContainer.style.display = 'block'; // Show results container on error
                    resultsContainer.innerHTML = `<div class="alert alert-danger">Error fetching search results. Please try again later.</div>`;
                    loadingIndicator.classList.add('d-none');
                    if (paginationNav) paginationNav.classList.add('d-none'); // Hide pagination on error
                    console.error('Search error:', error);
                });
        }
        
        function displayResults(data, viewType) {
            const results = data.results;
            
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <h4>No books found</h4>
                        <p class="text-muted">Try different keywords or check your spelling</p>
                    </div>
                `;
                return;
            }
            
            // Create container based on view type
            const container = document.createElement('div');
            container.className = viewType === 'grid' ? 'row' : 'row list-view';
            
            results.forEach(book => {
                if (viewType === 'grid') {
                    container.appendChild(createBookCard(book));
                } else {
                    container.appendChild(createBookListItem(book));
                }
            });
            
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(container);

            // Initialize covers for the newly added elements
            if (window.initializeBookCovers) {
                window.initializeBookCovers();
            }
        }
        
        function createBookCard(book) {
            const template = document.getElementById('bookCardTemplate');
            const card = template.content.cloneNode(true);
            
            const yearParam = publishedYear ? `&year=${publishedYear}` : '';
            const bookUrl = `/book/${book.id}?query=${encodeURIComponent(query)}&page=${currentPage + 1}&sort=${currentSort}&view=${currentView}${yearParam}`;
            
            const imgElementForCard = card.querySelector('.book-cover');
            const preferredUrl = book.coverImages && book.coverImages.preferredUrl ? book.coverImages.preferredUrl : (book.s3ImagePath || null);
            const fallbackUrl = book.coverImages && book.coverImages.fallbackUrl ? book.coverImages.fallbackUrl : '/images/placeholder-book-cover.svg';

            imgElementForCard.src = '/images/placeholder-book-cover.svg'; // Initial src
            imgElementForCard.alt = book.title ? `${book.title} cover` : 'Book cover';
            imgElementForCard.setAttribute('data-book-id', book.id);
            imgElementForCard.setAttribute('data-preferred-url', preferredUrl || '');
            imgElementForCard.setAttribute('data-fallback-url', fallbackUrl);
            imgElementForCard.setAttribute('data-ultimate-fallback', '/images/placeholder-book-cover.svg');
            
            const imgContainer = card.querySelector('.book-cover-container');
            if (imgContainer) {
                const imgLink = document.createElement('a');
                imgLink.href = bookUrl;
                
                imgElementForCard.parentNode.removeChild(imgElementForCard);
                imgLink.appendChild(imgElementForCard);

                imgContainer.innerHTML = ''; 
                imgContainer.appendChild(imgLink);
                
                if (book.averageRating) {
                    const newRatingBadge = document.createElement('div');
                    newRatingBadge.className = 'position-absolute top-0 end-0 m-2 badge bg-warning text-dark rating-badge';
                    const starIcon = document.createElement('i');
                    starIcon.className = 'fas fa-star me-1';
                    const ratingSpan = document.createElement('span');
                    ratingSpan.className = 'rating-value';
                    ratingSpan.textContent = book.averageRating;
                    newRatingBadge.appendChild(starIcon);
                    newRatingBadge.appendChild(ratingSpan);
                    imgContainer.appendChild(newRatingBadge); 
                } else {
                    const existingBadge = imgContainer.querySelector('.rating-badge');
                    if (existingBadge) existingBadge.remove();
                }

                // Add dev source indicator if in development mode
                if (isDevelopmentMode && book.coverImages && book.coverImages.source && book.coverImages.source.name) {
                    const devIndicator = document.createElement('div');
                    devIndicator.className = 'position-absolute bottom-0 start-0 m-2 dev-source-indicator dev-source-' + book.coverImages.source.name;
                    devIndicator.style.zIndex = '10';
                    devIndicator.style.width = '20px';
                    devIndicator.style.height = '20px';
                    devIndicator.style.display = 'flex';
                    devIndicator.style.alignItems = 'center';
                    devIndicator.style.justifyContent = 'center';
                    
                    let titleText = 'Source: ' + (book.coverImages.source.displayName || 'Unknown');
                    if (book.coverImages.preferredUrl) {
                        let preferredUrlAbbreviated = book.coverImages.preferredUrl.length > 70 ? book.coverImages.preferredUrl.substring(0, 70) + '...' : book.coverImages.preferredUrl;
                        titleText += ' | URL: ' + preferredUrlAbbreviated;
                    }
                    devIndicator.setAttribute('title', titleText);
                    
                    const checkIcon = document.createElement('i');
                    checkIcon.className = 'fas fa-check';
                    checkIcon.style.fontSize = '0.8em';
                    devIndicator.appendChild(checkIcon);
                    imgContainer.appendChild(devIndicator); // Append to the image container
                }
            }
            
            // Make the title clickable
            const titleElement = card.querySelector('.book-title');
            if (titleElement) {
                const titleLink = document.createElement('a');
                titleLink.href = bookUrl;
                titleLink.className = 'text-decoration-none text-dark';
                titleLink.textContent = book.title;
                titleElement.innerHTML = '';
                titleElement.appendChild(titleLink);
            }
            
            const authorText = book.authors && book.authors.length > 0 
                ? book.authors.join(', ') 
                : 'Unknown Author';
            const authorElement = card.querySelector('.book-author');
            if (authorElement) {
                authorElement.textContent = authorText;
            }
            
            // Set the view details button link
            const link = card.querySelector('.book-link');
            if (link) {
                link.href = bookUrl;
            }
            
            // Rating is now handled during image container creation
            
            // Add qualifier badges if they exist
            const qualifierBadgesContainer = card.querySelector('.qualifier-badges');
            if (qualifierBadgesContainer && book.qualifiers) {
                addQualifierBadges(qualifierBadgesContainer, book.qualifiers);
            }
            
            return card.querySelector('.col-sm-6');
        }
        
        function createBookListItem(book) {
            const template = document.getElementById('bookListItemTemplate');
            const listItem = template.content.cloneNode(true);
            
            const yearParam = publishedYear ? `&year=${publishedYear}` : '';
            const bookUrl = `/book/${book.id}?query=${encodeURIComponent(query)}&page=${currentPage + 1}&sort=${currentSort}&view=${currentView}${yearParam}`;
            
            const imgElementForListItem = listItem.querySelector('.book-cover');
            const preferredUrlListItem = book.coverImages && book.coverImages.preferredUrl ? book.coverImages.preferredUrl : (book.s3ImagePath || null);
            const fallbackUrlListItem = book.coverImages && book.coverImages.fallbackUrl ? book.coverImages.fallbackUrl : '/images/placeholder-book-cover.svg';

            imgElementForListItem.src = '/images/placeholder-book-cover.svg'; // Initial src
            imgElementForListItem.alt = book.title ? `${book.title} cover` : 'Book cover';
            imgElementForListItem.setAttribute('data-book-id', book.id);
            imgElementForListItem.setAttribute('data-preferred-url', preferredUrlListItem || '');
            imgElementForListItem.setAttribute('data-fallback-url', fallbackUrlListItem);
            imgElementForListItem.setAttribute('data-ultimate-fallback', '/images/placeholder-book-cover.svg');
            
            const imgWrapper = listItem.querySelector('.book-cover-wrapper');
            if (imgWrapper) {
                const imgLink = document.createElement('a');
                imgLink.href = bookUrl;

                imgElementForListItem.parentNode.removeChild(imgElementForListItem);
                imgLink.appendChild(imgElementForListItem);

                imgWrapper.innerHTML = '';
                imgWrapper.appendChild(imgLink);

                if (book.averageRating) {
                    const newRatingBadge = document.createElement('div');
                    newRatingBadge.className = 'position-absolute top-0 end-0 m-2 badge bg-warning text-dark rating-badge';
                    const starIcon = document.createElement('i');
                    starIcon.className = 'fas fa-star me-1';
                    const ratingSpan = document.createElement('span');
                    ratingSpan.className = 'rating-value';
                    ratingSpan.textContent = book.averageRating;
                    newRatingBadge.appendChild(starIcon);
                    newRatingBadge.appendChild(ratingSpan);
                    imgWrapper.appendChild(newRatingBadge);
                } else {
                    const existingBadge = imgWrapper.querySelector('.rating-badge');
                    if (existingBadge) existingBadge.remove();
                }

                // Add dev source indicator if in development mode (for list view)
                if (isDevelopmentMode && book.coverImages && book.coverImages.source && book.coverImages.source.name) {
                    const devIndicator = document.createElement('div');
                    devIndicator.className = 'position-absolute bottom-0 start-0 m-1 dev-source-indicator dev-source-' + book.coverImages.source.name; // m-1 for smaller margin in list
                    devIndicator.style.zIndex = '10';
                    devIndicator.style.width = '18px'; // Slightly smaller for list view
                    devIndicator.style.height = '18px';
                    devIndicator.style.display = 'flex';
                    devIndicator.style.alignItems = 'center';
                    devIndicator.style.justifyContent = 'center';

                    let titleText = 'Source: ' + (book.coverImages.source.displayName || 'Unknown');
                    if (book.coverImages.preferredUrl) {
                         let preferredUrlAbbreviated = book.coverImages.preferredUrl.length > 70 ? book.coverImages.preferredUrl.substring(0, 70) + '...' : book.coverImages.preferredUrl;
                        titleText += ' | URL: ' + preferredUrlAbbreviated;
                    }
                    devIndicator.setAttribute('title', titleText);

                    const checkIcon = document.createElement('i');
                    checkIcon.className = 'fas fa-check';
                    checkIcon.style.fontSize = '0.7em'; // Slightly smaller icon
                    devIndicator.appendChild(checkIcon);
                    imgWrapper.appendChild(devIndicator); // Append to the image wrapper
                }
            }
            
            const titleElement = listItem.querySelector('.book-title');
            if (titleElement) {
                const titleLink = document.createElement('a');
                titleLink.href = bookUrl;
                titleLink.className = 'text-decoration-none text-dark';
                titleLink.textContent = book.title;
                titleElement.innerHTML = '';
                titleElement.appendChild(titleLink);
            }
            
            const authorText = book.authors && book.authors.length > 0 
                ? book.authors.join(', ') 
                : 'Unknown Author';
            const authorElement = listItem.querySelector('.book-author');
            if (authorElement) {
                authorElement.textContent = authorText;
            }
            
            const description = book.description || 'No description available';
            const descriptionElement = listItem.querySelector('.book-description');
            if (descriptionElement) {
                descriptionElement.textContent = 
                    description.length > 200 ? description.substring(0, 200) + '...' : description;
            }
            
            // Set the view details button link
            const link = listItem.querySelector('.book-link');
            if (link) {
                link.href = bookUrl;
            }
            
            // Rating is now handled during image wrapper creation
            
            // Add categories if available
            const categoriesContainer = listItem.querySelector('.book-categories');
            if (book.categories && book.categories.length > 0) {
                book.categories.forEach(category => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-light text-dark';
                    badge.textContent = category;
                    categoriesContainer.appendChild(badge);
                });
            } else {
                categoriesContainer.style.display = 'none';
            }
            
            // Add qualifier badges if they exist
            const qualifierBadgesContainer = listItem.querySelector('.qualifier-badges');
            const listViewQualifierBadgesContainer = listItem.querySelector('.list-view-qualifier-badges');
            
            if (book.qualifiers) {
                // Add to thumbnail qualifier container
                if (qualifierBadgesContainer) {
                    addQualifierBadges(qualifierBadgesContainer, book.qualifiers);
                }
                
                // Add to list view horizontal qualifier container
                if (listViewQualifierBadgesContainer) {
                    addQualifierBadges(listViewQualifierBadgesContainer, book.qualifiers, true);
                }
            }
            
            return listItem.querySelector('.col-12');
        }
        
        function sortResults(results, sortBy) {
            switch(sortBy) {
                case 'title':
                    results.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'author':
                    results.sort((a, b) => {
                        const authorA = a.authors && a.authors.length > 0 ? a.authors[0] : '';
                        const authorB = b.authors && b.authors.length > 0 ? b.authors[0] : '';
                        return authorA.localeCompare(authorB);
                    });
                    break;
                case 'newest':
                    results.sort((a, b) => {
                        const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
                        const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
                        return dateB - dateA;
                    });
                    break;
                case 'rating':
                    results.sort((a, b) => {
                        const ratingA = a.averageRating || 0;
                        const ratingB = b.averageRating || 0;
                        return ratingB - ratingA;
                    });
                    break;
            }
        }
        
        function setupPagination(currentPage, totalItems, itemsPerPage) {
            console.log("setupPagination called with:", currentPage, totalItems, itemsPerPage);
            paginationContainer.innerHTML = ''; // Clear existing pagination
            
            if (!totalItems || totalItems <= itemsPerPage) {
                console.log("No pagination needed - total items <= items per page", totalItems, itemsPerPage);
                if (paginationNav) paginationNav.classList.add('d-none'); // Ensure nav is hidden
                return; // No pagination needed if total items fit on one page or no items
            }

            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (paginationNav) paginationNav.classList.remove('d-none'); // Show nav as we are adding items
            console.log("Calculated total pages:", totalPages);
            
            const ul = document.createElement('ul');
            ul.className = 'pagination';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.setAttribute('aria-label', 'Previous');
            prevLink.innerHTML = '<span aria-hidden="true">&laquo;</span>';
            if (currentPage > 0) {
                const url = new URL(window.location.href);
                url.searchParams.set('page', currentPage);
                prevLink.href = url.toString();
            } else {
                prevLink.href = '#';
            }
            prevLi.appendChild(prevLink);
            ul.appendChild(prevLi);

            // Page numbers (simplified: show current and a few around it)
            // For a more robust pagination, you'd implement logic for "..." and first/last page links
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, currentPage + 2);

            if (currentPage < 2 && totalPages > 4) endPage = 4; // Ensure enough pages show at start
            if (currentPage > totalPages - 3 && totalPages > 4) startPage = totalPages - 5; // Ensure enough pages show at end

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                const pageUrl = new URL(window.location.href);
                pageUrl.searchParams.set('page', i + 1);
                pageLink.href = pageUrl.toString();
                pageLink.textContent = i + 1;
                pageLi.appendChild(pageLink);
                ul.appendChild(pageLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.setAttribute('aria-label', 'Next');
            nextLink.innerHTML = '<span aria-hidden="true">&raquo;</span>';
            if (currentPage < totalPages - 1) {
                const nextUrl = new URL(window.location.href);
                nextUrl.searchParams.set('page', currentPage + 2);
                nextLink.href = nextUrl.toString();
            } else {
                nextLink.href = '#';
            }
            nextLi.appendChild(nextLink);
            ul.appendChild(nextLi);

            paginationContainer.appendChild(ul);
            console.log("Pagination added to DOM:", paginationContainer.innerHTML.length > 0);
            
            // Force repaint of the container with inline styles to ensure visibility - now applies to paginationNav
            if (paginationNav) {
                paginationNav.style.display = 'none'; // Hide then show to trigger repaint
                setTimeout(() => {
                    if (paginationContainer.innerHTML.trim() !== '') { // Only show if it has content
                        paginationNav.style.display = 'flex';
                        // paginationNav.style.border = '2px solid var(--primary-color)'; // Optional: for debugging visibility
                        // paginationNav.style.padding = '10px';
                        // paginationNav.style.margin = '20px 0';
                        // paginationNav.style.position = 'relative';
                        // paginationNav.style.zIndex = '100';
                        console.log("Forced repaint of paginationNav container with enhanced visibility");
                    } else {
                         paginationNav.classList.add('d-none'); // Keep hidden if no content
                    }
                }, 10);
            }
        }
        
        /**
         * Add qualifier badges to container element
         * 
         * @param {HTMLElement} container - The container element to add badges to
         * @param {Object} qualifiers - The qualifiers object from the book
         * @param {boolean} horizontal - Whether to use horizontal layout (for list view)
         */
        function addQualifierBadges(container, qualifiers, horizontal = false) {
            if (!qualifiers) return;
            
            // Clear any existing badges
            container.innerHTML = '';
            
            // New York Times Bestseller badge
            if (qualifiers.nytBestseller) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info text-dark mb-1 qualifier-badge';
                badge.innerHTML = '<i class="fas fa-award me-1"></i> NYT Bestseller';
                container.appendChild(badge);
            }
            
            // Award Winner badge
            if (qualifiers.awardWinner) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-success text-white mb-1 qualifier-badge';
                badge.innerHTML = '<i class="fas fa-trophy me-1"></i> Award Winner';
                container.appendChild(badge);
            }
            
            // Pulitzer Prize specific badge
            if (qualifiers.pulitzerPrize) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary text-white mb-1 qualifier-badge';
                badge.innerHTML = '<i class="fas fa-medal me-1"></i> Pulitzer Prize';
                container.appendChild(badge);
            }
            
            // Nobel Prize specific badge
            if (qualifiers.nobelPrize) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-danger text-white mb-1 qualifier-badge';
                badge.innerHTML = '<i class="fas fa-medal me-1"></i> Nobel Prize';
                container.appendChild(badge);
            }
            
            // Recommended/Best Books badge
            if (qualifiers.recommendedList) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary text-white mb-1 qualifier-badge';
                badge.innerHTML = '<i class="fas fa-thumbs-up me-1"></i> Recommended';
                container.appendChild(badge);
            }
            
            // Apply special styling for horizontal layout
            if (horizontal) {
                container.classList.add('horizontal-badges');
                const badges = container.querySelectorAll('.qualifier-badge');
                badges.forEach(badge => {
                    badge.classList.remove('mb-1');
                    badge.classList.add('me-1');
                });
            }
        }
    });
</script>

<style>
    /* Hide the dot during search loading */
    #searchResults:empty,
    #searchResults:not(:has(*)) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Ensure transparent background for loading state */
    #searchResults {
        background-color: transparent !important;
    }
    
    /* Hide stray pagination dot/container when pagination is empty */
    nav[aria-label="Search results pages"]:has(#pagination:empty) {
        display: none !important;
    }
    
    /* Hide pagination nav during loading */
    #loadingIndicator:not(.d-none) ~ nav {
        display: none !important;
    }
    
    .search-header {
        border-bottom: 1px solid #dee2e6;
    }

    /* Enhancements for book cover display */
    .book-cover-container, .book-cover-wrapper {
        position: relative; /* Needed for absolute positioning of rating badge */
        background-color: #f8f9fa; /* Light background for the image area */
        display: flex; /* Enable flex for centering */
        align-items: center; /* Vertical centering */
        justify-content: center; /* Horizontal centering */
        overflow: hidden; /* Ensure image doesn't spill out */
    }

    /* Grid View Specific Container Styling */
    .book-cover-container {
        width: 100%;
        aspect-ratio: 2 / 3; /* Common book cover aspect ratio, adjust as needed */
        padding: 5px; /* Add padding to prevent images from touching container edges */
        /* Alternatively, set a fixed height, e.g., height: 200px; */
    }

    /* List View Specific Container Styling */
    .book-cover-wrapper {
        width: 100%;
        height: 100%; /* Ensure it fills the md-2 column height */
        /* min-height: 150px; */ /* Or a min-height */
    }

    .book-cover {
        max-width: 100%;
        max-height: 100%;
        width: auto; /* Let it scale based on height */
        height: auto; /* Let it scale based on width */
        object-fit: contain; /* Scales down, doesn't scale up, maintains aspect ratio */
        display: block; /* Remove extra space below image */
    }

    .rating-badge {
        font-size: 0.75rem;
    }

    .badge {
        border-radius: 30px;
    }
    
    .badge.bg-info {
        background-color: #0dcaf0;
        color: #212529;
    }
    
    .dropdown-menu {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: none;
    }
    
    .dropdown-item.active, .dropdown-item:active {
        background-color: var(--primary-color);
    }
    
    /* Custom breakpoint for book cards */
    @media (min-width: 576px) and (max-width: 991.98px) {
        .col-sm-6.col-md-4.col-lg-3 {
            width: 50%;
        }
    }
    
    /* Hide spinner on number inputs */
    .no-spinner::-webkit-inner-spin-button, 
    .no-spinner::-webkit-outer-spin-button { 
        -webkit-appearance: none;
        margin: 0;
    }
    .no-spinner {
        -moz-appearance: textfield;
        appearance: textfield;
    }
    
    /* Qualifier badge styling */
    .qualifier-badge {
        font-size: 0.7rem;
        max-width: 125px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .qualifier-badges {
        z-index: 5;
        max-width: 80%;
    }
    
    .horizontal-badges {
        flex-direction: row !important;
        flex-wrap: wrap;
    }
    
    .list-view-qualifier-badges {
        margin-top: 5px;
    }
</style>

</body>
</html>
