# Database Schema Retrofit Task Checklist

## Overview

This document tracks all code changes required to retrofit the application for the new PostgreSQL schema that includes:

- UUIDv7 for books.id (generated by application)
- NanoID for all other tables
- Normalized external IDs and provider metadata
- Unified collections for categories and lists
- Full-text search with materialized views

## Schema Coverage Decisions

- [ ] Add persistence plan for book qualifiers (e.g., create `book_qualifiers` table or store structured JSON alongside book records).
- [ ] Define storage for cached recommendation IDs (introduce a `book_recommendation_cache` table keyed by canonical book UUID).
- [ ] Decide how to persist cover image metadata (width/height/high-res flags) and preferred/fallback sourcesâ€”extend `book_image_links` or add `book_cover_metadata`.
- [x] Finalize DRY edition strategy (`Book.EditionInfo`): `books` carry `edition_number`/`edition_group_key` and `book_editions` only stores sibling links when multiple canonical editions exist.
- [ ] Confirm whether `rawRatingsData` / `hasRatings` should be retained (store in JSONB) or removed from the domain model.
- [ ] Document qualifier semantics (search intent tags like `nytBestseller`, `awardWinner`, `searchQuery`, `queryTerms`) and persist them in Postgres if the feature remains.
- [x] Introduce normalized tag tables (`book_tags`, `book_tag_equivalents`, `book_tag_assignments`) so qualifiers live in Postgres instead of S3 JSON.

## ðŸ”´ Critical Path - Database Operations

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/BookDataOrchestrator.java`

**Priority**: CRITICAL
**Changes Required**:

- [x] Generate UUIDv7 IDs via `IdGenerator.uuidV7()`, compute stable slugs with `SlugGenerator`, and persist timestamps when writing to `books`.
- [x] Strip provider fields from `books` upsert logic; only canonical columns (title, subtitle, description, ISBNs, published_date, language, page_count, slug, s3_image_path) are stored.
- [x] Persist provider metadata through `book_external_ids` (pricing, availability flags, ratings, canonical links, provider ISBN/ASIN, country) with NanoID keys.
- [x] Insert raw API payloads into `book_raw_data` per source with `fetched_at`/`contributed_at` timestamps to audit upstream data.
- [x] Normalize authors: upsert into `authors`, maintain order in `book_authors_join`; external IDs pending future providers.
- [x] Map Google categories and NYT lists into `book_collections` / `book_collections_join` with correct `collection_type`, `source`, ranking metadata, and provider references.
- [x] Capture physical metadata in `book_dimensions` whenever height/width/thickness/weight are present. (2025-09-20)
- [x] Store canonical cover path in `books.s3_image_path`, push external image URLs into `book_image_links`, and sync `book_editions` links only when a work has multiple canonical siblings.
- [x] Extract shared persistence helpers for authors, categories, qualifier tags, and collections so orchestrator/scheduler reuse a single implementation.
- [x] Replace legacy `book_lists` / `book_lists_join` SQL with `book_collections` tables across insert/update/select flows.
- [ ] Update DB read methods to reconstruct domain `Book` by joining authors, collections, external IDs, dimensions, images, and raw data.
  - [x] Hydrate authors, categories, tags, cover images, provider metadata, and recommendation IDs straight from Postgres via `PostgresBookReader` (2025-09-20).
  - [x] Fold in dimensions + raw payload joins so physical metadata/debug provenance flow through the reader (`PostgresBookReader` now hydrates `book_dimensions` + latest `book_raw_data`).
- [x] Hydrate edition chains by joining `book_editions`/`book_editions_chain` so services can return sibling formats in a single query.
- [x] Ensure dependent table inserts use NanoIDs from `IdGenerator` and run inside transactions/batched operations for referential integrity.
- [x] Trigger `refresh_book_search_view()` after bulk writes and expose throttled refresh hook for orchestrated jobs. (2025-09-20)
- [x] Flip tiered fetch pipeline to Postgres-first (DB â†’ S3 â†’ APIs) and treat S3 JSON as optional fallback cache only â€” `PostgresBookReader` now fronts all identifier lookups and returns canonical slugs (2025-09-20).

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/model/Book.java`

**Priority**: HIGH
**Changes Required**:

- [ ] Change `id` to `UUID` and introduce `subtitle`, `slug`, `createdAt`, `updatedAt` to mirror canonical table columns.
- [ ] Move provider-specific primitives (ratings, pricing, availability, purchase/info links, ASIN) into dedicated value objects backed by `book_external_ids` records.
- [ ] Model authors, categories/collections, and dimensions as typed aggregates keyed by canonical IDs instead of raw strings.
- [ ] Replace ad-hoc cover fields (`externalImageUrl`, width/height/highRes flags) with a cover asset model aligned with `books.s3_image_path` and `book_image_links`.
- [ ] Rework qualifiers & cached recommendations to reference Postgres persistence (see Schema Coverage Decisions) rather than in-memory lists.
- [x] Replace the in-memory `qualifiers` map with data sourced from `book_tag_assignments`.
- [ ] Update constructors/builders, equals/hashCode, and serialization helpers to accommodate new types.

## ðŸŸ¡ ID Generation

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/util/IdGenerator.java`

**Priority**: HIGH
**Status**: âœ… Already exists
**Changes Required**:

- [ ] Verify it matches our requirements (UUIDv7, NanoID with different sizes)
- [ ] Add unit tests for ID generation methods

## ðŸŸ¡ Service Layer Updates

### [x] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/NewYorkTimesService.java`

**Priority**: MEDIUM
**Changes Required**:

- [x] Persist list metadata into `book_collections` with `collection_type='BESTSELLER_LIST'`, `source='NYT'`, normalized names, and provider codes/dates.
- [x] Populate `book_collections_join` with rank/position, weeks-on-list, provider ISBN references, and raw item JSON.
- [x] Ensure lookups for bestsellers query Postgres-first (no S3 JSON) using canonical UUIDs.
- [x] Generate NanoIDs via `IdGenerator` for new collection and join rows and wrap entire refresh in transactions.
- [x] Promote `book_collections`/`book_collections_join` writes as the single source and delete legacy `book_lists*` SQL.

### [x] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/NewYorkTimesBestsellerScheduler.java`

**Priority**: HIGH
**Changes Required**:

- [x] Drop S3 list persistence (`lists/nyt/...`) and write list snapshots into Postgres (`book_collections`, `book_collections_join`, `book_tag_assignments`).
- [x] Remove Google Books fallback loops once canonical data lives in Postgres.
- [x] Emit tag assignments (`nyt_bestseller`, list codes) through the new tag tables instead of embedding values in JSON.
- [x] Refresh `book_editions` / search view after each job to keep DB current.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/GoogleBooksService.java`

**Priority**: MEDIUM (if exists)
**Changes Required**:

- [ ] Store Google Books volume IDs and metadata in `book_external_ids`, including pricing/availability fields.
- [ ] Map `volumeInfo` content (subtitle, publisher, language, page count) into canonical `books` columns and refresh slug/updated timestamps.
- [ ] Extract authors, categories, dimensions, and image links, delegating to orchestrator methods that target Postgres tables.
- [ ] Shift search/fetch flows to call Postgres-first (via new repository/search service) and only fall back to live API when DB misses occur.
- [ ] After API fetch, persist raw payloads, refresh materialized view, and fan out updates to dependent caches.
- [x] Persist edition rows (metadata plus optional `related_book_id`) in `book_editions` whenever APIs expose alternate bindings/volumes.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/BookSearchService.java` (NEW)

**Priority**: HIGH
**Changes Required**:

- [x] Create new service to wrap search functions (BookSearchService wired for Postgres search, 2025-09-20)
- [x] Implement searchBooks() method calling PostgreSQL function
- [x] Implement searchByISBN() method (returns canonical result metadata, 2025-09-20)
- [x] Implement searchAuthors() method (Postgres relevance ranking, 2025-09-20)
- [x] Add method to refresh materialized view after bulk updates (BookSearchService.refreshMaterializedView(), 2025-09-20)

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/BookApiProxy.java`

**Priority**: HIGH
**Changes Required**:

- [ ] Query Postgres (via new repository/search service) for canonical books before consulting S3 or external APIs.
- [ ] Map provider IDs to canonical UUIDs using `book_external_ids` so callers can ask with either identifier.
- [ ] On API fallback, persist results through `BookDataOrchestrator` to hydrate all normalized tables.
- [ ] Simplify caching pipeline: treat S3/local disk as optional read-through layers fed by Postgres writes.
- [ ] Ensure reactive caches emit domain objects enriched with authors/collections from the database, not raw API payloads.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/BookDataAggregatorService.java`

**Priority**: MEDIUM
**Changes Required**:

- [ ] Produce aggregation DTOs that feed `BookDataOrchestrator` table-specific writers (books, external IDs, raw data, collections).
- [ ] Normalize edition/qualifier metadata so it can be stored in schema-backed tables (see Schema Coverage Decisions).
- [ ] Remove assumptions about S3 JSON shape; operate on canonical Postgres models.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/RecommendationService.java`

**Priority**: HIGH
**Changes Required**:

- [ ] Replace Google Books searches with Postgres search functions (`search_books`, `search_authors`) and similarity scoring from stored data.
- [ ] Persist recommendation caches in Postgres (new table) and hydrate `Book` domain objects accordingly.
- [ ] Use `book_collections` / `book_collections_join` for category-based recommendations.
- [ ] Remove direct dependency on `GoogleBooksService` except as final fallback when DB has gaps.
- [ ] Tag recommendations (e.g., `similar_author`, `similar_category`) using `book_tag_assignments` where appropriate.
- [ ] Retire redundant `BookSimilarityService` usage once Postgres-first search flow is in place.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/RecentlyViewedService.java`

**Priority**: MEDIUM
**Changes Required**:

- [ ] Resolve canonical books via Postgres repository (UUID or slug) instead of Google API.
- [ ] Decide on persistence layer (Postgres vs in-memory) for recently viewed list and align with new schema.
- [ ] Ensure cover data uses `books.s3_image_path` / `book_image_links` rather than external URLs only.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/controller/BookController.java`

**Priority**: MEDIUM
**Changes Required**:

- [ ] Return Postgres-first DTOs enriched with authors, tags, editions, collections, and cover metadata.
- [ ] Remove dependencies on S3 JSON and legacy fields (`external_image_url`, etc.).
- [ ] Add endpoints/filters for tag-driven queries (e.g., NYT bestsellers) leveraging `book_tag_assignments`.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/S3RetryService.java`

**Priority**: LOW
**Changes Required**:

- [ ] Limit responsibility to cover/image assets; stop treating S3 JSON as authoritative once Postgres is seeded.
- [ ] Remove qualifier-specific JSON merge logic once qualifiers move to Postgres.
- [ ] Update metrics to reflect fallback-only usage.
- [ ] Delete JSON fetch/upload helpers once tag persistence lands; keep only cover upload helpers.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/S3StorageService.java`

**Priority**: LOW
**Changes Required**:

- [ ] Audit callers and keep only cover-upload/download flows; retire book metadata storage paths (`books/v1`).
- [ ] Ensure uploaded cover metadata feeds `books.s3_image_path` and related tables.
- [ ] Remove JSON fetch/upload methods that become unused after Postgres-first migration.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/DuplicateBookService.java`

**Priority**: LOW
**Changes Required**:

- [ ] Replace with Postgres-driven dedupe (slug/ISBN matching) or delete the service once edition/table logic covers canonical linking.
- [ ] Update `RecentlyViewedService` and `HomeController` to rely on Postgres lookups instead of the placeholder service.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/similarity/BookSimilarityService.java`

**Priority**: LOW
**Changes Required**:

- [ ] Remove once recommendation/search services are fully Postgres-first and no beans depend on it.
- [ ] If embeddings return, back them with stored vectors in Postgres instead of Google fallback.

## Next Actions

1. **Extend integration coverage** â€“ baseline unit suite now passes via `./mvnw -q -DskipITs -Pci-skip-wro test`; add integration scenarios for dedupe, edition chaining, NYT ingest, and tag persistence ahead of controller DTO rewrites.
   - [x] Added sitemap scheduler smoke test (`SitemapRefreshSchedulerIntegrationTest`) to exercise snapshot upload, external hydration, and cover warmups together (2025-09-19).
   - [x] Published reusable Postgres fixtures (`PostgresFixtures` + `book_with_collections_and_tags.json`) for consistent test data (2025-09-19).
   - [x] Introduced shared `BookDto` / mapper layer to centralise API response mapping ahead of controller rewrites (2025-09-19).
   - [x] Add dedicated scenarios for dedupe, edition chaining, NYT ingest, and tag persistence. (2025-09-19) â€“ see new tests under `src/test/java/com/williamcallahan/book_recommendation_engine/service`.
2. **Expose normalized data in public APIs** â€“ update controllers/DTOs (see `BookController` task) so clients get editions, tags, and collection data directly from Postgres.
3. **Recommendation-layer refactor** â€“ migrate cached recommendations to Postgres, tag results appropriately, and retire S3 JSON usage.
4. **Legacy cleanup** â€“ remove `DuplicateBookService`, `BookSimilarityService`, and S3 JSON helpers once all callers use the Postgres-first pipeline (shared persistence services now cover authors/categories/tags).
5. **Historical data seeding** â€“ decide whether to backfill tags/editions from S3 history and implement a one-time seed script if needed.
6. **Backfill edition heuristics** â€“ audit `edition_number`/`edition_group_key` quality, import historical signals, and produce a cleanup task list for ambiguous works.

## Test Status (2025-09-19)

- [x] `BookControllerTest` â€“ Verified green under `./mvnw -q -DskipITs -Pci-skip-wro test` (2025-09-19 20:41 PT); mocks remain stable after Postgres-first service refactors.
- [x] `BookCoverManagementServiceS3UploadTest` â€“ Passing with shared persistence guardrails; no additional code changes required after cache directory fallbacks.
- [x] `BookCoverManagementServiceTest` â€“ Updated fallback handling in `src/main/java/com/williamcallahan/book_recommendation_engine/service/image/BookCoverManagementService.java:133` so S3 hits surface canonical URLs and StepVerifier assertions now succeed.
- [x] Re-ran `./mvnw -q -DskipITs -Pci-skip-wro test` (2025-09-19 20:41 PT) â€“ full unit suite green; retain command for future regression checks.

### [x] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/BookSitemapService.java`

**Priority**: MEDIUM
**Changes Required**:

- [x] Source book IDs/URLs directly from Postgres (slug + updated_at) instead of S3 JSON files.
- [x] Introduce pagination/batching queries to generate sitemap feeds from `books` + `book_collections`.
- [x] Enforce `sitemap.s3.accumulated-ids-key` configuration when S3 uploads are enabled to prevent silent skips (fail-fast guard added 2025-09-19).
- [x] Consolidated scheduler now drives Postgres snapshot upload, optional S3 persistence, external hydration, and cover warmups (`SitemapRefreshScheduler`).

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/service/image/BookImageOrchestrationService.java`

**Priority**: MEDIUM
**Changes Required**:

- [ ] Update to read/write cover metadata using `books` + `book_image_links` (and potential cover metadata table).
- [ ] Ensure image provenance and resolution preferences persist in Postgres rather than transient memory.

## ðŸŸ¢ Controller Updates

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/controller/BookController.java`

**Priority**: MEDIUM
**Changes Required**:

- [ ] Accept canonical UUIDs and slugs in path/query parameters and resolve via Postgres first.
- [ ] Back search endpoints with `BookSearchService` (Postgres functions) and only call external APIs on explicit refresh requests.
- [ ] Return DTOs that include authors, collections, provider metadata, and cover assets from normalized tables.
- [ ] Add author search endpoint powered by `search_authors()`.
- [ ] Update recommendation endpoints to use Postgres-derived data/caches.
- [ ] Include linked editions in responses by joining `book_editions`/`book_editions_chain` and grouping sibling formats.
- [ ] Return qualifier/tag metadata from `book_tag_assignments` so UI can display badges/filters.
- [ ] Send explicit `ResponseEntity` objects with correct status codes (`201` for create, `404` on misses) and JSON bodies so `BookControllerTest` expectations remain valid after Postgres-first changes.

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/controller/BookCoverController.java`

**Priority**: LOW
**Changes Required**:

- [ ] Use books.s3_image_path for our stored images
- [ ] Fallback to book_image_links for external URLs
- [ ] Update image retrieval logic to read from Postgres tables only (no S3 metadata lookups).
- [ ] Serve variants/resolution preferences using persisted cover metadata.

## ðŸŸ¢ Migration Scripts

### [ ] `/migrate-s3-to-db.js` (Node.js migration script)

- Schema reference: see `book_recommendation_engine_uml.puml` for the current ER diagram backbone. Regenerate via `./mvnw -q -DskipITs -Pci-skip-wro test && plantuml book_recommendation_engine_uml.puml` when tables change.

**Priority**: HIGH
**Changes Required**:

- [ ] Generate UUIDv7 for books and NanoIDs for related tables via `IdGenerator` parity (port to Node or call API).
- [ ] Populate `books`, `book_external_ids`, `book_raw_data`, `authors`, `book_authors_join`, `book_dimensions`, `book_image_links`, `book_collections`, and `book_collections_join` from S3 JSON.
- [ ] Persist provider metadata (pricing, availability, ratings) in `book_external_ids` rows.
- [ ] Capture categories/lists with proper `collection_type`, `source`, provider codes, and ranking metadata.
- [ ] Write raw payload JSONB per source into `book_raw_data` with timestamps.
- [ ] Remove legacy references to `book_lists`, `book_categories`, `external_image_url`, etc.
- [ ] Batch inserts and wrap in transactions to maintain FK integrity.
- [x] Persist edition links only when a group has multiple canonical siblings; skip singleton rows and keep `book_editions` metadata-free.
- [ ] Add reconciliation pass that backfills `edition_number`/links for historical records once S3 migration finishes.
- [x] Persist tag assignments and equivalence links into `book_tags`, `book_tag_equivalents`, `book_tag_assignments`.

### [ ] Create new migration class in Java (if needed)

**Priority**: MEDIUM
**Changes Required**:

- [ ] Implement comprehensive S3 to PostgreSQL migration
- [ ] Handle all normalized tables (external IDs, authors, collections, dimensions, images, raw data).
- [ ] Include error handling, transactional batching, and retry/resume support.
- [ ] Refresh `book_search_view` on completion and produce reconciliation reports.
- [ ] Refresh any edition helper views (`book_editions_chain`) after migrations complete.
- [ ] Seed tag tables (including equivalence links) from existing S3 qualifier data (if retained).

## ðŸ”µ Configuration & Setup

### [ ] `/src/main/resources/application.yml`

**Priority**: LOW
**Changes Required**:

- [ ] Verify PostgreSQL 17 compatibility settings
- [ ] Add configuration for search refresh intervals
- [ ] Consider adding batch size settings for migrations

### [ ] `/src/main/java/com/williamcallahan/book_recommendation_engine/config/DatabaseConfig.java` (NEW)

**Priority**: MEDIUM
**Changes Required**:

- [ ] Create configuration for JdbcTemplate beans
- [ ] Add scheduled task to refresh materialized view
- [ ] Configure connection pooling for search operations

### âœ… CI Build Profile

- [x] Add `ci-skip-wro` Maven profile (activated via `-Pci-skip-wro` or `-Dci.skip.wro=true`) so automated pipelines can skip the wro4j asset build that requires JVM agent attachment.

## ðŸ”µ Frontend/Templates

### [ ] `/src/main/resources/templates/search.html`

**Priority**: LOW
**Changes Required**:

- [ ] Update to handle UUID book IDs in URLs
- [ ] Display author information from joined data
- [ ] Show relevance scores or match types
- [ ] Add author search UI

### [ ] `/src/main/resources/templates/book-detail.html` (if exists)

**Priority**: LOW
**Changes Required**:

- [ ] Display data from multiple related tables
- [ ] Show provider-specific information separately
- [ ] Display categories/collections

## Documentation Updates

- [ ] Refresh `docs/database_id_strategy.md` to align with new tables (book_collections, book_collections_join, book_image_links, etc.).
- [ ] Update `docs/database_s3_object_schema_mapping.md` to remove deprecated tables and reflect Postgres-first flow.
- [ ] Document new Postgres-first retrieval strategy (BookApiProxy/BookSearchService) in README or dedicated ops guide.

## Testing Requirements

### [ ] Create integration tests for new schema

- [ ] Test UUIDv7 generation for books
- [ ] Test NanoID generation for other tables
- [ ] Test search functions with various queries
- [ ] Test materialized view refresh
- [ ] Test data integrity across related tables
- [ ] Test Postgres-first fetch pipeline (BookApiProxy/BookDataOrchestrator) including fallback order.
- [ ] Test persistence of categories, authors, image links, dimensions, and raw data.
- [ ] Validate recommendation cache persistence and retrieval once new table exists.
- [ ] Verify edition metadata persistence (metadata-only rows, canonical links, and `book_editions_chain` view resolution).
- [ ] Verify qualifier/tag persistence (synonym detection, assignment writes, query filters).
- [x] Run CI/automation with `-Pci-skip-wro` to bypass the wro4j asset build in sandboxed environments (validated via `./mvnw -q -DskipITs -Pci-skip-wro test` on 2025-09-19).

### [ ] Update existing tests

- [ ] Fix tests expecting String IDs to handle UUID
- [ ] Update mock data to match new schema
- [ ] Add tests for author management
- [ ] Add tests for collection management
- [ ] Add tests for cover image metadata handling
- [ ] Add tests for provider metadata mapping (pricing, availability, ratings)

## Data Migration Steps

### Pre-Migration Checklist

- [ ] Backup existing database
- [ ] Run `make db-reset` to create fresh schema
- [ ] Verify all tables created successfully
- [ ] Test search functions work

### Migration Execution

- [ ] Run S3 to PostgreSQL migration for books
- [ ] Verify books have UUIDv7 IDs
- [ ] Verify authors extracted and linked
- [ ] Verify categories migrated to collections
- [ ] Refresh materialized view
- [ ] Test search functionality

### Post-Migration Validation

- [ ] Verify no data loss
- [ ] Check foreign key relationships
- [ ] Test all search strategies
- [ ] Monitor query performance
- [ ] Verify image paths correct

## Performance Considerations

### [ ] Add database indexes monitoring

- [ ] Monitor search query performance
- [ ] Check materialized view refresh time
- [ ] Optimize batch insert operations
- [ ] Consider partitioning for large tables

### [ ] Implement caching strategy

- [ ] Cache frequently searched books
- [ ] Cache author information
- [ ] Cache collection listings
- [ ] Implement cache invalidation

## Rollback Plan

### [ ] Document rollback procedure

- [ ] Keep backup of old schema
- [ ] Maintain data export before migration
- [ ] Test rollback procedure in staging
- [ ] Document recovery time objective

## Success Criteria

- [ ] All CRUD operations work with new schema
- [ ] Search returns relevant results with <100ms response time
- [ ] No data loss during migration
- [ ] All foreign key constraints satisfied
- [ ] Application passes all integration tests
- [ ] Materialized view refreshes successfully
- [ ] Book retrieval flows hit Postgres first; S3/API used only as fallback and persist back to DB.

## Notes

1. **ID Strategy**: Books use UUIDv7 for time-ordering and global uniqueness. All other tables use NanoID with sizes based on expected volume.

2. **Search Priority**:
   - Exact title matches (1.0)
   - Full-text with weights A-D
   - Fuzzy matches (0.8 * similarity)

3. **Provider Data**: All provider-specific data (ratings, links, availability) moved to book_external_ids table

4. **Collections**: Categories and lists unified in book_collections table with collection_type field

5. **Dependencies**: Requires PostgreSQL 17 with pg_trgm extension
