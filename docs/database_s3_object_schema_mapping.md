# Database Schema Field Mapping

## JSON to PostgreSQL Field Mapping

### Core Book Data → `books` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `id` (Google Books) | — | — | NOT stored in books.id; goes to book_external_ids.external_id |
| Generated | `id` | uuid | UUIDv7 generated by IdGenerator.uuidV7() |
| `volumeInfo.title` | `title` | text | Required field |
| `volumeInfo.subtitle` | `subtitle` | text | Optional |
| `volumeInfo.description` | `description` | text | HTML content from providers |
| `volumeInfo.industryIdentifiers[type=ISBN_10].identifier` | `isbn10` | text | Canonical ISBN-10 |
| `volumeInfo.industryIdentifiers[type=ISBN_13].identifier` | `isbn13` | text | Canonical ISBN-13 |
| `volumeInfo.publishedDate` | `published_date` | date | Parsed from various formats |
| `volumeInfo.language` | `language` | text | ISO 639-1 code (e.g., 'en') |
| `volumeInfo.publisher` | `publisher` | text | Publisher name |
| `volumeInfo.pageCount` | `page_count` | integer | Or volumeInfo.printedPageCount |
| Generated from image | `s3_image_path` | text | Our S3 path (e.g., 'covers/isbn13/9781234567890.jpg') |

### Provider-Specific Data → `book_external_ids` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `id` | `external_id` | text | Google Books ID, OpenLibrary ID, etc. |
| — | `source` | text | 'GOOGLE_BOOKS', 'OPEN_LIBRARY', 'AMAZON' |
| `volumeInfo.industryIdentifiers[type=ISBN_10].identifier` | `provider_isbn10` | text | Provider's ISBN-10 |
| `volumeInfo.industryIdentifiers[type=ISBN_13].identifier` | `provider_isbn13` | text | Provider's ISBN-13 |
| — | `provider_oclc` | text | OCLC if available |
| — | `provider_lccn` | text | Library of Congress number |
| — | `provider_asin` | text | Amazon ASIN |
| `volumeInfo.infoLink` | `info_link` | text | Provider info page |
| `volumeInfo.previewLink` | `preview_link` | text | Preview page |
| `accessInfo.webReaderLink` | `web_reader_link` | text | Web reader URL |
| `volumeInfo.canonicalVolumeLink` | `canonical_volume_link` | text | Canonical provider link |
| `volumeInfo.averageRating` | `average_rating` | numeric | Provider's rating |
| `volumeInfo.ratingsCount` | `ratings_count` | integer | Number of ratings |
| `saleInfo.isEbook` | `is_ebook` | boolean | eBook availability |
| `accessInfo.pdf.isAvailable` | `pdf_available` | boolean | PDF availability |
| `accessInfo.epub.isAvailable` | `epub_available` | boolean | EPUB availability |
| `accessInfo.embeddable` | `embeddable` | boolean | Can be embedded |
| `accessInfo.publicDomain` | `public_domain` | boolean | Public domain status |
| `accessInfo.viewability` | `viewability` | text | 'FULL', 'PARTIAL', 'NO_PAGES' |
| `volumeInfo.readingModes.text` | `text_readable` | boolean | Text mode available |
| `volumeInfo.readingModes.image` | `image_readable` | boolean | Image mode available |
| `volumeInfo.printType` | `print_type` | text | 'BOOK', 'MAGAZINE' |
| `volumeInfo.maturityRating` | `maturity_rating` | text | 'NOT_MATURE', 'MATURE' |
| `volumeInfo.contentVersion` | `content_version` | text | Provider's content version |
| `accessInfo.textToSpeechPermission` | `text_to_speech_permission` | text | 'ALLOWED', etc. |
| `saleInfo.saleability` | `saleability` | text | 'FOR_SALE', 'NOT_FOR_SALE' |
| `saleInfo.country` or `accessInfo.country` | `country_code` | text | Country code |
| `saleInfo.listPrice.amount` | `list_price` | numeric | List price |
| `saleInfo.retailPrice.amount` | `retail_price` | numeric | Retail price |
| `saleInfo.listPrice.currencyCode` | `currency_code` | text | Currency code |

### Authors → `authors` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `volumeInfo.authors[]` | `name` | text | Each array element becomes a record |
| — | `normalized_name` | text | Generated: lowercase, no accents |
| — | `birth_date` | date | From external sources |
| — | `death_date` | date | From external sources |
| — | `biography` | text | From external sources |
| — | `nationality` | text | From external sources |

### Categories → `book_collections` table (type='CATEGORY')

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `volumeInfo.categories[]` | `display_name` | text | Each array element |
| — | `collection_type` | text | 'CATEGORY' |
| — | `source` | text | 'GOOGLE_BOOKS' |
| — | `normalized_name` | text | For deduplication |

### Dimensions → `book_dimensions` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `volumeInfo.dimensions.height` | `height_cm` | numeric | Parsed from "23.00 cm" |
| `volumeInfo.dimensions.width` | `width_cm` | numeric | If available |
| `volumeInfo.dimensions.thickness` | `thickness_cm` | numeric | If available |
| — | `weight_grams` | numeric | From other sources |

### Image Links → `book_image_links` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| `volumeInfo.imageLinks.smallThumbnail` | `url` | text | With image_type='smallThumbnail' |
| `volumeInfo.imageLinks.thumbnail` | `url` | text | With image_type='thumbnail' |
| — | `source` | text | 'GOOGLE_BOOKS' |

### Raw Data → `book_raw_data` table

| JSON Path | PostgreSQL Column | Type | Notes |
|-----------|------------------|------|--------|
| Entire response | `raw_json_response` | jsonb | Complete API response |
| — | `source` | text | 'GOOGLE_BOOKS', etc. |
| — | `fetched_at` | timestamptz | When fetched |
| — | `contributed_at` | timestamptz | When contributed |

## ID Generation Strategy

### Primary Keys by Table

| Table | ID Type | Generator | Size |
|-------|---------|-----------|------|
| `books` | UUIDv7 | `IdGenerator.uuidV7()` | 36 chars |
| `authors` | NanoID | `IdGenerator.generate()` | 10 chars |
| `book_external_ids` | NanoID | `IdGenerator.generate()` | 10 chars |
| `author_external_ids` | NanoID | `IdGenerator.generate()` | 10 chars |
| `book_authors_join` | NanoID | `IdGenerator.generateLong()` | 12 chars (high volume) |
| `book_collections` | NanoID | `IdGenerator.generateShort()` | 8 chars (low volume) |
| `book_collections_join` | NanoID | `IdGenerator.generateLong()` | 12 chars (high volume) |
| `book_raw_data` | NanoID | `IdGenerator.generate()` | 10 chars |
| `book_dimensions` | NanoID | `IdGenerator.generateShort()` | 8 chars (low volume) |
| `book_image_links` | NanoID | `IdGenerator.generate()` | 10 chars |

## Migration from Old Schema

### Deprecated Tables (DO NOT USE)
- `book_contributing_sources` → Merged into `book_raw_data`
- `book_identifiers` → Merged into `book_external_ids`
- `categories` → Replaced by `book_collections` with type='CATEGORY'
- `book_categories` → Replaced by `book_collections_join`
- `book_lists` → Replaced by `book_collections` with type='BESTSELLER_LIST'
- `book_lists_join` → Replaced by `book_collections_join`

### Key Changes
1. **books.id** is now UUIDv7 (not provider IDs)
2. **Provider IDs** moved to `book_external_ids.external_id`
3. **Categories and lists** unified in `book_collections`
4. **ISBNs** stored in both canonical (books table) and provider-specific (book_external_ids) locations
5. **Images**: Our S3 path in `books.s3_image_path`, external URLs in `book_image_links`
6. **Raw JSON** stored for reprocessing and debugging